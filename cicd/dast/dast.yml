dast:
  stage: test
  tags:
    - dev
  image:
    name: "registry.gitlab.com/gitlab-org/security-products/dast:$CI_SERVER_VERSION_MAJOR-$CI_SERVER_VERSION_MINOR-stable"
  variables:
    # Time limit for target availability (scan is attempted even when timeout):
    DAST_TARGET_AVAILABILITY_TIMEOUT: 180
    # Perform ZAP Full Scan, which includes both passive and active scanning:
    DAST_FULL_SCAN_ENABLED: "true"
    #
    # Set these variables to scan with an authenticated user:
    # DAST_AUTH_URL: https://example.com/sign-in
    # DAST_USERNAME: john.doe@example.com
    # DAST_PASSWORD: john-doe-password
    # DAST_USERNAME_FIELD: session[user] # the name of username field at the sign-in HTML form
    # DAST_PASSWORD_FIELD: session[password] # the name of password field at the sign-in HTML form
    # DAST_AUTH_EXCLUDE_URLS: http://example.com/sign-out,http://example.com/sign-out-2 # optional: URLs to skip during the authenticated scan; comma-separated, no spaces in between
  allow_failure: false
  script:
    - export DAST_WEBSITE=${DAST_WEBSITE:-$(cat environment_url.txt)}
    - /analyze -t $DAST_WEBSITE
  artifacts:
    when: always
    paths:
      [gl-dast-report.json]
  only:
    refs:
      - branches
  except:
    - tags
